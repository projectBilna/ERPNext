frappe.provide('erpnext');$(document).bind('toolbar_setup',function(){frappe.app.name="ERPNext";frappe.help_feedback_link='<p><a class="text-muted" \
  href="https://discuss.erpnext.com">Feedback</a></p>'
$('.navbar-home').html('<img class="erpnext-icon" src="'+
frappe.urllib.get_base_url()+'/assets/erpnext/images/erp-icon.svg" />');$('[data-link="docs"]').attr("href","https://manual.erpnext.com")});$.extend(frappe.create_routes,{"Customer Group":"Sales Browser/Customer Group","Territory":"Sales Browser/Territory","Item Group":"Sales Browser/Item Group","Sales Person":"Sales Browser/Sales Person","Account":"Accounts Browser/Account","Cost Center":"Accounts Browser/Cost Center"});$.extend(frappe.breadcrumbs.preferred,{"Item Group":"Stock","Customer Group":"Selling","Supplier Type":"Buying","Territory":"Selling","Sales Person":"Selling","Sales Partner":"Selling","Brand":"Selling"});;frappe.provide("erpnext.feature_setup");erpnext.feature_setup.feature_dict={'fs_projects':{'BOM':{'fields':['project_name']},'Delivery Note':{'fields':['project_name']},'Purchase Invoice':{'items':['project_name']},'Production Order':{'fields':['project_name']},'Purchase Order':{'items':['project_name']},'Purchase Receipt':{'items':['project_name']},'Sales Invoice':{'fields':['project_name']},'Sales Order':{'fields':['project_name']},'Stock Entry':{'fields':['project_name']},'Timesheet':{'timesheet_details':['project_name']}},'fs_discounts':{'Delivery Note':{'items':['discount_percentage']},'Quotation':{'items':['discount_percentage']},'Sales Invoice':{'items':['discount_percentage']},'Sales Order':{'items':['discount_percentage','price_list_rate']}},'fs_purchase_discounts':{'Purchase Order':{'items':['base_price_list_rate','discount_percentage','price_list_rate']},'Purchase Receipt':{'items':['base_price_list_rate','discount_percentage','price_list_rate']},'Purchase Invoice':{'items':['base_price_list_rate','discount_percentage','price_list_rate']}},'fs_brands':{'Delivery Note':{'items':['brand']},'Material Request':{'items':['brand']},'Item':{'fields':['brand']},'Purchase Order':{'items':['brand']},'Purchase Invoice':{'items':['brand']},'Quotation':{'items':['brand']},'Sales Invoice':{'items':['brand']},'Product Bundle':{'fields':['new_item_brand']},'Sales Order':{'items':['brand']},'Serial No':{'fields':['brand']}},'fs_after_sales_installations':{'Delivery Note':{'fields':['installation_status','per_installed'],'items':['installed_qty']}},'fs_item_batch_nos':{'Delivery Note':{'items':['batch_no']},'Item':{'fields':['has_batch_no']},'Purchase Receipt':{'items':['batch_no']},'Quality Inspection':{'fields':['batch_no']},'Sales and Pruchase Return Wizard':{'return_details':['batch_no']},'Sales Invoice':{'items':['batch_no']},'Stock Entry':{'items':['batch_no']},'Stock Ledger Entry':{'fields':['batch_no']}},'fs_item_serial_nos':{'Warranty Claim':{'fields':['serial_no']},'Delivery Note':{'items':['serial_no'],'packed_items':['serial_no']},'Installation Note':{'items':['serial_no']},'Item':{'fields':['has_serial_no']},'Maintenance Schedule':{'items':['serial_no'],'schedules':['serial_no']},'Maintenance Visit':{'purposes':['serial_no']},'Purchase Receipt':{'items':['serial_no']},'Quality Inspection':{'fields':['item_serial_no']},'Sales and Pruchase Return Wizard':{'return_details':['serial_no']},'Sales Invoice':{'items':['serial_no']},'Stock Entry':{'items':['serial_no']},'Stock Ledger Entry':{'fields':['serial_no']}},'fs_item_barcode':{'Item':{'fields':['barcode']},'Delivery Note':{'items':['barcode']},'Sales Invoice':{'items':['barcode']},'Stock Entry':{'items':['barcode']},'Purchase Receipt':{'items':['barcode']}},'fs_item_group_in_details':{'Delivery Note':{'items':['item_group']},'Opportunity':{'items':['item_group']},'Material Request':{'items':['item_group']},'Item':{'fields':['item_group']},'Global Defaults':{'fields':['default_item_group']},'Purchase Order':{'items':['item_group']},'Purchase Receipt':{'items':['item_group']},'Purchase Voucher':{'items':['item_group']},'Quotation':{'items':['item_group']},'Sales Invoice':{'items':['item_group']},'Product Bundle':{'fields':['serial_no']},'Sales Order':{'items':['item_group']},'Serial No':{'fields':['item_group']},'Sales Partner':{'targets':['item_group']},'Sales Person':{'targets':['item_group']},'Territory':{'targets':['item_group']}},'fs_page_break':{'Delivery Note':{'items':['page_break'],'packed_items':['page_break']},'Material Request':{'items':['page_break']},'Purchase Order':{'items':['page_break']},'Purchase Receipt':{'items':['page_break']},'Purchase Voucher':{'items':['page_break']},'Quotation':{'items':['page_break']},'Sales Invoice':{'items':['page_break']},'Sales Order':{'items':['page_break']}},'fs_exports':{'Delivery Note':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_rounded_total','base_total','base_net_total','base_discount_amount','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'POS Profile':{'fields':['conversion_rate','currency']},'Quotation':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_rounded_total','base_total','base_net_total','base_discount_amount','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'Sales Invoice':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_rounded_total','base_total','base_net_total','base_discount_amount','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'Product Bundle':{'fields':['currency']},'Sales Order':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_rounded_total','base_total','base_net_total','base_discount_amount','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']}},'fs_imports':{'Purchase Invoice':{'fields':['conversion_rate','currency','base_grand_total','base_discount_amount','base_in_words','base_total','base_net_total','base_taxes_and_charges_added','base_taxes_and_charges_deducted','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'Purchase Order':{'fields':['conversion_rate','currency','base_grand_total','base_discount_amount','base_in_words','base_total','base_net_total','base_taxes_and_charges_added','base_taxes_and_charges_deducted','base_total_taxes_and_charges'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'Purchase Receipt':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_total','base_net_total','base_taxes_and_charges_added','base_taxes_and_charges_deducted','base_total_taxes_and_charges','base_discount_amount'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']},'Supplier Quotation':{'fields':['conversion_rate','currency','base_grand_total','base_in_words','base_total','base_net_total','base_taxes_and_charges_added','base_taxes_and_charges_deducted','base_total_taxes_and_charges','base_discount_amount'],'items':['base_price_list_rate','base_amount','base_rate','base_net_rate','base_net_amount']}},'fs_item_advanced':{'Item':{'fields':['customer_items']}},'fs_sales_extras':{'Address':{'fields':['sales_partner']},'Contact':{'fields':['sales_partner']},'Customer':{'fields':['sales_team']},'Delivery Note':{'fields':['sales_team']},'Item':{'fields':['customer_items']},'Sales Invoice':{'fields':['sales_team']},'Sales Order':{'fields':['sales_team']}},'fs_more_info':{"Warranty Claim":{"fields":["more_info"]},'Material Request':{'fields':['more_info']},'Lead':{'fields':['more_info']},'Opportunity':{'fields':['more_info']},'Purchase Invoice':{'fields':['more_info']},'Purchase Order':{'fields':['more_info']},'Purchase Receipt':{'fields':['more_info']},'Supplier Quotation':{'fields':['more_info']},'Quotation':{'fields':['more_info']},'Sales Invoice':{'fields':['more_info']},'Sales Order':{'fields':['more_info']},'Delivery Note':{'fields':['more_info']},},'fs_quality':{'Item':{'fields':['inspection_criteria','inspection_required']},'Purchase Receipt':{'items':['qa_no']}},'fs_manufacturing':{'Item':{'fields':['manufacturing']}},'fs_pos':{'Sales Invoice':{'fields':['is_pos']}},'fs_recurring_invoice':{'Sales Invoice':{'fields':['recurring_invoice']}}}
$(document).bind('form_refresh',function(){var feature_dict=erpnext.feature_setup.feature_dict;for(var sys_feat in sys_defaults){if(sys_defaults[sys_feat]=='0'&&(sys_feat in feature_dict)){if(cur_frm.doc.doctype in feature_dict[sys_feat]){for(var fort in feature_dict[sys_feat][cur_frm.doc.doctype]){if(fort=='fields'){hide_field(feature_dict[sys_feat][cur_frm.doc.doctype][fort]);}else if(cur_frm.fields_dict[fort]){cur_frm.fields_dict[fort].grid.set_column_disp(feature_dict[sys_feat][cur_frm.doc.doctype][fort],false);}else{msgprint(__('Grid "')+fort+__('" does not exists'));}}}}}});frappe.provide("erpnext");frappe.provide("erpnext.utils");$.extend(erpnext,{get_currency:function(company){if(!company&&cur_frm)
company=cur_frm.doc.company;if(company)
return frappe.get_doc(":Company",company).default_currency||frappe.boot.sysdefaults.currency;else
return frappe.boot.sysdefaults.currency;},get_fiscal_year:function(company,date,fn){if(frappe.meta.get_docfield(cur_frm.doctype,"fiscal_year")){frappe.call({type:"GET",method:"erpnext.accounts.utils.get_fiscal_year",args:{"company":company,"date":date,"verbose":0},callback:function(r){if(r.message)cur_frm.set_value("fiscal_year",r.message[0]);if(fn)fn();}});}},toggle_naming_series:function(){if(cur_frm.fields_dict.naming_series){cur_frm.toggle_display("naming_series",cur_frm.doc.__islocal?true:false);}},hide_company:function(){if(cur_frm.fields_dict.company){var companies=Object.keys(locals[":Company"]||{});if(companies.length===1){if(!cur_frm.doc.company)cur_frm.set_value("company",companies[0]);cur_frm.toggle_display("company",false);}else if(erpnext.last_selected_company){if(!cur_frm.doc.company)cur_frm.set_value("company",erpnext.last_selected_company);}}},add_applicable_territory:function(){if(cur_frm.doc.__islocal&&(cur_frm.doc.territories||[]).length===0){var default_territory=frappe.defaults.get_user_default("territory");if(default_territory){var territory=frappe.model.add_child(cur_frm.doc,"Applicable Territory","territories");territory.territory=default_territory;}}},setup_serial_no:function(){var grid_row=cur_frm.open_grid_row();if(!grid_row.fields_dict.serial_no||grid_row.fields_dict.serial_no.get_status()!=="Write")return;var $btn=$('<button class="btn btn-sm btn-default">'+__("Add Serial No")+'</button>').appendTo($("<div>").css({"margin-bottom":"10px","margin-top":"10px"}).appendTo(grid_row.fields_dict.serial_no.$wrapper));$btn.on("click",function(){var d=new frappe.ui.Dialog({title:__("Add Serial No"),fields:[{"fieldtype":"Link","options":"Serial No","label":__("Serial No"),"get_query":function(){return{filters:{item_code:grid_row.doc.item_code,warehouse:cur_frm.doc.is_return?null:grid_row.doc.warehouse}}}},{"fieldtype":"Button","label":__("Add")}]});d.get_input("add").on("click",function(){var serial_no=d.get_value("serial_no");if(serial_no){var val=(grid_row.doc.serial_no||"").split("\n").concat([serial_no]).join("\n");grid_row.fields_dict.serial_no.set_model_value(val.trim());}
d.hide();return false;});d.show();});}});$.extend(erpnext.utils,{render_address_and_contact:function(frm){$(frm.fields_dict['address_html'].wrapper).html(frappe.render_template("address_list",cur_frm.doc.__onload)).find(".btn-address").on("click",function(){new_doc("Address");});if(frm.fields_dict['contact_html']){$(frm.fields_dict['contact_html'].wrapper).html(frappe.render_template("contact_list",cur_frm.doc.__onload)).find(".btn-contact").on("click",function(){new_doc("Contact");});}},copy_value_in_all_row:function(doc,dt,dn,table_fieldname,fieldname){var d=locals[dt][dn];if(d[fieldname]){var cl=doc[table_fieldname]||[];for(var i=0;i<cl.length;i++){if(!cl[i][fieldname])cl[i][fieldname]=d[fieldname];}}
refresh_field(table_fieldname);}});$(document).on('app_ready',function(){if(!frappe.datetime.is_timezone_same()){$.each(["Stock Reconciliation","Stock Entry","Stock Ledger Entry","Delivery Note","Purchase Receipt","Sales Invoice"],function(i,d){frappe.ui.form.on(d,"onload",function(frm){cur_frm.set_df_property("posting_time","description",sys_defaults.time_zone);});});}});;frappe.provide("erpnext.queries");$.extend(erpnext.queries,{user:function(){return{query:"frappe.core.doctype.user.user.user_query"};},lead:function(){return{query:"erpnext.controllers.queries.lead_query"};},customer:function(){return{query:"erpnext.controllers.queries.customer_query"};},supplier:function(){return{query:"erpnext.controllers.queries.supplier_query"};},item:function(filters){var args={query:"erpnext.controllers.queries.item_query"};if(filters)args["filters"]=filters;return args;},bom:function(){return{query:"erpnext.controllers.queries.bom"};},task:function(){return{query:"erpnext.projects.utils.query_task"};},customer_filter:function(doc){if(!doc.customer){frappe.throw(__("Please specify a")+" "+
__(frappe.meta.get_label(doc.doctype,"customer",doc.name)));}
return{filters:{customer:doc.customer}};},supplier_filter:function(doc){if(!doc.supplier){frappe.throw(__("Please specify a")+" "+
__(frappe.meta.get_label(doc.doctype,"supplier",doc.name)));}
return{filters:{supplier:doc.supplier}};},lead_filter:function(doc){if(!doc.lead){frappe.throw(__("Please specify a")+" "+
__(frappe.meta.get_label(doc.doctype,"lead",doc.name)));}
return{filters:{lead:doc.lead}};},not_a_group_filter:function(){return{filters:{is_group:"No"}};},employee:function(){return{query:"erpnext.controllers.queries.employee_query"}},warehouse:function(doc){return{filters:[["Warehouse","company","in",["",cstr(doc.company)]]]}}});erpnext.queries.setup_queries=function(frm,options,query_fn){var me=this;var set_query=function(doctype,parentfield){var link_fields=frappe.meta.get_docfields(doctype,frm.doc.name,{"fieldtype":"Link","options":options});$.each(link_fields,function(i,df){if(parentfield){frm.set_query(df.fieldname,parentfield,query_fn);}else{frm.set_query(df.fieldname,query_fn);}});};set_query(frm.doc.doctype);$.each(frappe.meta.get_docfields(frm.doc.doctype,frm.doc.name,{"fieldtype":"Table"}),function(i,df){set_query(df.options,df.fieldname);});};frappe.provide("erpnext.utils");erpnext.utils.get_party_details=function(frm,method,args,callback){if(!method){method="erpnext.accounts.party.get_party_details";}
if(!args){if(frm.doc.customer){args={party:frm.doc.customer,party_type:"Customer",price_list:frm.doc.selling_price_list};}else if(frm.doc.supplier){args={party:frm.doc.supplier,party_type:"Supplier",price_list:frm.doc.buying_price_list};}}
if(!args)return;args.currency=frm.doc.currency;args.company=frm.doc.company;args.doctype=frm.doc.doctype;frappe.call({method:method,args:args,callback:function(r){if(r.message){frm.updating_party_details=true;frm.set_value(r.message);frm.updating_party_details=false;if(callback)callback();}}});}
erpnext.utils.get_address_display=function(frm,address_field,display_field){if(frm.updating_party_details)return;if(!address_field){if(frm.doc.customer){address_field="customer_address";}else if(frm.doc.supplier){address_field="supplier_address";}else return;}
if(!display_field)display_field="address_display";if(frm.doc[address_field]){frappe.call({method:"erpnext.utilities.doctype.address.address.get_address_display",args:{"address_dict":frm.doc[address_field]},callback:function(r){if(r.message)
frm.set_value(display_field,r.message)}})}}
erpnext.utils.get_contact_details=function(frm){if(frm.updating_party_details)return;if(frm.doc["contact_person"]){frappe.call({method:"erpnext.utilities.doctype.contact.contact.get_contact_details",args:{contact:frm.doc.contact_person},callback:function(r){if(r.message)
frm.set_value(r.message);}})}};frappe.templates["address_list"] = '<p><button class="btn btn-xs btn-default btn-address">New Address</button></p> <div class="clearfix"></div> {% for(var i=0, l=addr_list.length; i<l; i++) { %} <p class="h6"> {%= i+1 %}. {%= addr_list[i].address_type %} {% if(addr_list[i].is_primary_address) { %} <span class="text-muted">({%= __("Primary") %})</span>{% } %} {% if(addr_list[i].is_shipping_address) { %} <span class="text-muted">({%= __("Shipping") %})</span>{% } %} <a href="#Form/Address/{%= addr_list[i].name %}" class="btn btn-default btn-xs pull-right"> {%= __("Edit") %}</a> </p> <div style="padding-left: 15px;"> <p style="margin-top: 5px; font-size: 12px;"> {%= addr_list[i].display %}</p> </div> {% } %} {% if(!addr_list.length) { %} <p class="text-muted">{%= __("No address added yet.") %}</p> {% } %} ';
frappe.templates["contact_list"] = '<p><button class="btn btn-xs btn-default btn-contact"> New Contact</button></p> <div class="clearfix"></div> {% for(var i=0, l=contact_list.length; i<l; i++) { %} <p class="h6"> {%= i+1 %}. {%= contact_list[i].first_name %} {%= contact_list[i].last_name %} {% if(contact_list[i].is_primary_contact) { %} <span class="text-muted">({%= __("Primary") %})</span> {% } %} <a href="#Form/Contact/{%= contact_list[i].name %}" class="btn btn-xs btn-default pull-right"> {%= __("Edit") %}</a> </p> <div style="padding-left: 15px;"> <p style="padding-top: 5px; font-size: 12px;"> {% if(contact_list[i].phone) { %} {%= __("Phone") %}: {%= contact_list[i].phone %}<br> {% } %} {% if(contact_list[i].mobile_no) { %} {%= __("Mobile No.") %}: {%= contact_list[i].mobile_no %}<br> {% } %} {% if(contact_list[i].email_id) { %} {%= __("Email ID") %}: {%= contact_list[i].email_id %} {% } %} </p> </div> {% } %} {% if(!contact_list.length) { %} <p class="text-muted">{%= __("No contacts added yet.") %}</p> {% } %} ';
frappe.templates["pos"] = '<div class="pos"> <div class="row"> <div class="col-sm-5 pos-bill-wrapper"> <div class="pos-bill-toolbar row"> <div class="party-area col-xs-12"></div> </div> <div class="pos-bill"> <div class="item-cart"> <div class="row pos-bill-row pos-bill-header"> <div class="col-xs-5"><h6>{%= __("Item") %}</h6></div> <div class="col-xs-4"><h6 class="text-right">{%= __("Quantity") %}</h6></div> <div class="col-xs-3"><h6 class="text-right">{%= __("Rate") %}</h6></div> </div> <div class="items"></div> </div> <div class="totals-area"> <div class="row pos-bill-row net-total-area"> <div class="col-xs-6"><h6 class="text-muted">{%= __("Net Total") %}</h6></div> <div class="col-xs-6"><h6 class="net-total text-right"></h6></div> </div> <div class="row pos-bill-row tax-area hide"> <div class="col-xs-12 text-muted"> <h6>{%= __("Taxes") %}</h6> <div class="tax-table small"></div> </div> </div> <div class="row pos-bill-row discount-amount-area"> <div class="col-xs-6"><h6 class="text-muted">{%= __("Discount Amount") %}</h6></div> <div class="col-xs-6"><input type="text" class="form-control discount-amount text-right"></div> </div> <div class="row pos-bill-row grand-total-area"> <div class="col-xs-6"><h6>{%= __("Grand Total") %}</h6></div> <div class="col-xs-6"><h6 class="grand-total text-right"></h6></div> </div>  </div> </div> </div> <div class="col-sm-7 pos-item-area"> <div class="row pos-item-toolbar"> <div class="search-area col-xs-12"></div> </div> <div class="item-list-area"> <div class="item-list"></div> </div> </div> </div> </div> ';
frappe.templates["pos_bill_item"] = '<div class="row pos-bill-row pos-bill-item" data-item-code="{%= item_code %}"> <div class="col-xs-5"><h6>{%= item_code || "" %}{%= item_name || "" %}</h6></div> <div class="col-xs-4"> <div class="row pos-qty-row"> <div class="col-xs-2 text-center pos-qty-btn" data-action="decrease-qty"><i class="icon-minus-sign text-muted"></i></div> <div class="col-xs-8"> <div> <input type="text" value="{%= qty %}" class="form-control input-sm pos-item-qty text-right"> </div> {% if(actual_qty != null) { %} <div style="margin-top: 5px;" class="text-muted small text-right"> <span title="{%= __("In Stock") %}">{%= actual_qty || 0 %}<span> <span title="{%= __("Projected") %}">({%= projected_qty || 0 %})<span> </div> {% } %} </div> <div class="col-xs-2 text-center pos-qty-btn" data-action="increase-qty"><i class="icon-plus-sign text-muted"></i></div> </div> </div> <div class="col-xs-3 text-right"> <h6>{%= amount %}<div class="text-muted" style="margin-top: 5px;">{%= rate %}</div></h6> </div> </div> ';
frappe.templates["pos_item"] = '<div class="pos-item" data-item-code="{%= item_code %}" title="{%= item_name || item_code %}"> <div class="pos-item-image {% if (!item_image) { %} no-image {% } %}" style="{% if (item_image) { %} background-image: {%= item_image %} {% } %}"> </div> <div class="pos-item-text"> <h6 class="item-code text-ellipsis">{%= item_name ? (item_name + " (" + item_code + ")") : item_code %}</h6> <div class="small text-ellipsis">{%= item_price %}</div> </div> </div> ';
frappe.templates["pos_tax_row"] = '<div class="row"> <div class="col-xs-9">{%= description %}</div> <div class="col-xs-3 text-right">{%= tax_amount %}</div> </div> ';
frappe.provide("erpnext.pos");erpnext.pos.PointOfSale=Class.extend({init:function(wrapper,frm){this.wrapper=wrapper;this.frm=frm;this.wrapper.html(frappe.render_template("pos",{}));this.check_transaction_type();this.make();var me=this;$(this.frm.wrapper).on("refresh-fields",function(){me.refresh();});this.wrapper.find('input.discount-amount').on("change",function(){frappe.model.set_value(me.frm.doctype,me.frm.docname,"discount_amount",flt(this.value));});},check_transaction_type:function(){var me=this;if(frappe.meta.has_field(cur_frm.doc.doctype,"customer")){this.set_transaction_defaults("Customer");}
else if(frappe.meta.has_field(cur_frm.doc.doctype,"supplier")){this.set_transaction_defaults("Supplier");}},set_transaction_defaults:function(party){var me=this;this.party=party;this.price_list=(party=="Customer"?this.frm.doc.selling_price_list:this.frm.doc.buying_price_list);this.price_list_field=(party=="Customer"?"selling_price_list":"buying_price_list");this.sales_or_purchase=(party=="Customer"?"Sales":"Purchase");},make:function(){this.make_party();this.make_search();this.make_item_list();},make_party:function(){var me=this;this.party_field=frappe.ui.form.make_control({df:{"fieldtype":"Link","options":this.party,"label":this.party,"fieldname":"pos_party","placeholder":this.party},parent:this.wrapper.find(".party-area"),only_input:true,});this.party_field.make_input();this.party_field.$input.on("change",function(){if(!me.party_field.autocomplete_open)
frappe.model.set_value(me.frm.doctype,me.frm.docname,me.party.toLowerCase(),this.value);});},make_search:function(){var me=this;this.search=frappe.ui.form.make_control({df:{"fieldtype":"Data","label":"Item","fieldname":"pos_item","placeholder":"Search Item"},parent:this.wrapper.find(".search-area"),only_input:true,});this.search.make_input();this.search.$input.on("keypress",function(){if(!me.search.autocomplete_open)
if(me.item_timeout)
clearTimeout(me.item_timeout);me.item_timeout=setTimeout(function(){me.make_item_list();},1000);});},make_item_list:function(){var me=this;if(!this.price_list){msgprint(__("Price List not found or disabled"));return;}
me.item_timeout=null;frappe.call({method:'erpnext.accounts.doctype.sales_invoice.pos.get_items',args:{sales_or_purchase:this.sales_or_purchase,price_list:this.price_list,item:this.search.$input.val()},callback:function(r){var $wrap=me.wrapper.find(".item-list");me.wrapper.find(".item-list").empty();if(r.message){if(r.message.length===1){var item=r.message[0];if(item.serial_no){me.add_to_cart(item.item_code,item.serial_no);me.search.$input.val("");return;}else if(item.barcode){me.add_to_cart(item.item_code);me.search.$input.val("");return;}}
$.each(r.message,function(index,obj){$(frappe.render_template("pos_item",{item_code:obj.name,item_price:format_currency(obj.price_list_rate,obj.currency),item_name:obj.name===obj.item_name?"":obj.item_name,item_image:obj.image?"url('"+obj.image+"')":null})).tooltip().appendTo($wrap);});}
$(me.wrapper).find("div.pos-item").on("click",function(){if(me.frm.doc.docstatus==0){me.add_to_cart($(this).attr("data-item-code"));}});}});},add_to_cart:function(item_code,serial_no){var me=this;var caught=false;if(!me.frm.doc[me.party.toLowerCase()]&&((me.frm.doctype=="Quotation"&&me.frm.doc.quotation_to=="Customer")||me.frm.doctype!="Quotation")){msgprint(__("Please select {0} first.",[me.party]));return;}
var no_of_items=me.wrapper.find(".pos-bill-item").length;if(no_of_items!=0){$.each(this.frm.doc["items"]||[],function(i,d){if(d.item_code==item_code){caught=true;if(serial_no)
frappe.model.set_value(d.doctype,d.name,"serial_no",d.serial_no+'\n'+serial_no);else
frappe.model.set_value(d.doctype,d.name,"qty",d.qty+1);}});}
if(!caught)
this.add_new_item_to_grid(item_code,serial_no);this.refresh();this.refresh_search_box();},add_new_item_to_grid:function(item_code,serial_no){var me=this;var child=frappe.model.add_child(me.frm.doc,this.frm.doctype+" Item","items");child.item_code=item_code;child.qty=1;if(serial_no)
child.serial_no=serial_no;this.frm.script_manager.trigger("item_code",child.doctype,child.name);frappe.after_ajax(function(){me.frm.script_manager.trigger("qty",child.doctype,child.name);})},refresh_search_box:function(){var me=this;if(this.search.$input.val()){this.search.set_input("");this.make_item_list();}},update_qty:function(item_code,qty){var me=this;$.each(this.frm.doc["items"]||[],function(i,d){if(d.item_code==item_code){if(qty==0){frappe.model.clear_doc(d.doctype,d.name);me.refresh_grid();}else{frappe.model.set_value(d.doctype,d.name,"qty",qty);}}});this.refresh();},refresh:function(){var me=this;this.refresh_item_list();this.refresh_fields();if(this.frm.doc.docstatus===0){this.call_when_local();}
this.disable_text_box_and_button();this.set_primary_action();if(this.frm.doctype=="Quotation"&&this.frm.doc.quotation_to!="Customer"){this.party_field.$input.prop("disabled",true);}},refresh_fields:function(){this.party_field.set_input(this.frm.doc[this.party.toLowerCase()]);this.wrapper.find('input.discount-amount').val(this.frm.doc.discount_amount);this.show_items_in_item_cart();this.show_taxes();this.set_totals();},refresh_item_list:function(){var me=this;if(this.frm.doc[this.price_list_field]!=this.price_list){this.price_list=this.frm.doc[this.price_list_field];this.make_item_list();}},show_items_in_item_cart:function(){var me=this;var $items=this.wrapper.find(".items").empty();$.each(this.frm.doc.items||[],function(i,d){$(frappe.render_template("pos_bill_item",{item_code:d.item_code,item_name:(d.item_name===d.item_code||!d.item_name)?"":("<br>"+d.item_name),qty:d.qty,actual_qty:d.actual_qty,projected_qty:d.projected_qty,rate:format_currency(d.rate,me.frm.doc.currency),amount:format_currency(d.amount,me.frm.doc.currency)})).appendTo($items);});this.wrapper.find("input.pos-item-qty").on("focus",function(){$(this).select();});},show_taxes:function(){var me=this;var taxes=this.frm.doc["taxes"]||[];$(this.wrapper).find(".tax-area").toggleClass("hide",(taxes&&taxes.length)?false:true).find(".tax-table").empty();$.each(taxes,function(i,d){if(d.tax_amount){$(frappe.render_template("pos_tax_row",{description:d.description,tax_amount:format_currency(flt(d.tax_amount)/flt(me.frm.doc.conversion_rate),me.frm.doc.currency)})).appendTo(me.wrapper.find(".tax-table"));}});},set_totals:function(){var me=this;this.wrapper.find(".net-total").text(format_currency(me.frm.doc["net_total"],me.frm.doc.currency));this.wrapper.find(".grand-total").text(format_currency(me.frm.doc.grand_total,me.frm.doc.currency));},call_when_local:function(){var me=this;$(this.wrapper).find("input.pos-item-qty").on("change",function(){var item_code=$(this).parents(".pos-bill-item").attr("data-item-code");me.update_qty(item_code,$(this).val());});$(this.wrapper).find(".pos-qty-btn").on("click",function(){var $item=$(this).parents(".pos-bill-item:first");me.increase_decrease_qty($item,$(this).attr("data-action"));});this.focus();},focus:function(){if(this.frm.doc[this.party.toLowerCase()]){this.search.$input.focus();}else{if(!(this.frm.doctype=="Quotation"&&this.frm.doc.quotation_to!="Customer"))
this.party_field.$input.focus();}},increase_decrease_qty:function($item,operation){var item_code=$item.attr("data-item-code");var item_qty=cint($item.find("input.pos-item-qty").val());if(operation=="increase-qty")
this.update_qty(item_code,item_qty+1);else if(operation=="decrease-qty"&&item_qty!=0)
this.update_qty(item_code,item_qty-1);},disable_text_box_and_button:function(){var me=this;$(this.wrapper).find(".pos-qty-btn").toggle(this.frm.doc.docstatus===0);$(this.wrapper).find('input, button').prop("disabled",!(this.frm.doc.docstatus===0));this.wrapper.find(".pos-item-area").toggleClass("hide",me.frm.doc.docstatus!==0);},set_primary_action:function(){var me=this;if(this.frm.page.current_view_name==="main")return;if(this.frm.doctype=="Sales Invoice"&&this.frm.doc.docstatus===0){if(!this.frm.doc.is_pos){this.frm.set_value("is_pos",1);}
this.frm.page.set_primary_action(__("Pay"),function(){me.make_payment();});}else if(this.frm.doc.docstatus===1){this.frm.page.set_primary_action(__("New"),function(){erpnext.open_as_pos=true;new_doc(me.frm.doctype);});}},refresh_delete_btn:function(){$(this.wrapper).find(".remove-items").toggle($(".item-cart .warning").length?true:false);},remove_selected_items:function(){var me=this;var selected_items=[];var no_of_items=$(this.wrapper).find("#cart tbody tr").length;for(var x=0;x<=no_of_items-1;x++){var row=$(this.wrapper).find("#cart tbody tr:eq("+x+")");if(row.attr("data-selected")=="true"){selected_items.push(row.attr("id"));}}
var child=this.frm.doc["items"]||[];$.each(child,function(i,d){for(var i in selected_items){if(d.item_code==selected_items[i]){frappe.model.clear_doc(d.doctype,d.name);}}});this.refresh_grid();},refresh_grid:function(){this.frm.dirty();this.frm.fields_dict["items"].grid.refresh();this.frm.script_manager.trigger("calculate_taxes_and_totals");this.refresh();},with_modes_of_payment:function(callback){var me=this;if(me.modes_of_payment){callback();}else{me.modes_of_payment=[];$.ajax("/api/resource/Mode of Payment").success(function(data){$.each(data.data,function(i,d){me.modes_of_payment.push(d.name);});callback();});}},make_payment:function(){var me=this;var no_of_items=this.frm.doc.items.length;if(no_of_items==0)
msgprint(__("Payment cannot be made for empty cart"));else{this.with_modes_of_payment(function(){var default_mode=me.frm.doc.mode_of_payment?me.frm.doc.mode_of_payment:me.modes_of_payment.indexOf(__("Cash"))!==-1?__("Cash"):undefined;var dialog=new frappe.ui.Dialog({width:400,title:'Payment',fields:[{fieldtype:'Currency',fieldname:'total_amount',label:__('Total Amount'),read_only:1,"default":me.frm.doc.grand_total,read_only:1},{fieldtype:'Select',fieldname:'mode_of_payment',label:__('Mode of Payment'),options:me.modes_of_payment.join('\n'),reqd:1,"default":default_mode},{fieldtype:'Currency',fieldname:'paid_amount',label:__('Amount Paid'),reqd:1,"default":me.frm.doc.grand_total,hidden:1,change:function(){var values=dialog.get_values();dialog.set_value("change",Math.round(values.paid_amount-values.total_amount));dialog.get_input("change").trigger("change");}},{fieldtype:'Currency',fieldname:'change',label:__('Change'),"default":0.0,hidden:1,change:function(){var values=dialog.get_values();var write_off_amount=(flt(values.paid_amount)-flt(values.change))-values.total_amount;dialog.get_field("write_off_amount").toggle(write_off_amount);dialog.set_value("write_off_amount",write_off_amount);}},{fieldtype:'Currency',fieldname:'write_off_amount',label:__('Write Off'),"default":0.0,hidden:1},]});me.dialog=dialog;dialog.show();dialog.get_input("total_amount").prop("disabled",true);dialog.get_input("write_off_amount").prop("disabled",true);dialog.get_input("mode_of_payment").on("change",function(){var is_cash=dialog.get_value("mode_of_payment")===__("Cash");dialog.get_field("paid_amount").toggle(is_cash);dialog.get_field("change").toggle(is_cash);if(is_cash&&!dialog.get_value("change")){dialog.set_value("paid_amount",dialog.get_value("total_amount"));dialog.get_input("paid_amount").trigger("change");}}).trigger("change");me.set_pay_button(dialog);});}},set_pay_button:function(dialog){var me=this;dialog.set_primary_action(__("Pay"),function(){var values=dialog.get_values();var is_cash=values.mode_of_payment===__("Cash");if(!is_cash){values.write_off_amount=values.change=0.0;values.paid_amount=values.total_amount;}
me.frm.set_value("mode_of_payment",values.mode_of_payment);var paid_amount=flt((flt(values.paid_amount)-flt(values.change))/me.frm.doc.conversion_rate,precision("paid_amount"));me.frm.set_value("paid_amount",paid_amount);me.frm.set_value("write_off_amount",me.frm.doc.base_grand_total-paid_amount);me.frm.set_value("outstanding_amount",0);me.frm.savesubmit(this);dialog.hide();})}});erpnext.pos.make_pos_btn=function(frm){frm.page.add_menu_item(__("{0} View",[frm.page.current_view_name==="pos"?"Form":"Point-of-Sale"]),function(){erpnext.pos.toggle(frm);});if(frm.pos_btn)return;if(cint(sys_defaults.fs_pos_view)!==1||frm.doctype==="Material Request"){return;}
if(!frm.pos_btn){frm.pos_btn=frm.page.add_action_icon("icon-th",function(){erpnext.pos.toggle(frm);});}
if(erpnext.open_as_pos&&frm.page.current_view_name!=="pos"){erpnext.pos.toggle(frm,true);}}
erpnext.pos.toggle=function(frm,show){var price_list=frappe.meta.has_field(cur_frm.doc.doctype,"selling_price_list")?frm.doc.selling_price_list:frm.doc.buying_price_list;if(show!==undefined){if((show===true&&frm.page.current_view_name==="pos")||(show===false&&frm.page.current_view_name==="main")){return;}}
if(frm.page.current_view_name!=="pos"){if(!price_list){frappe.throw(__("Please select Price List"));}
if(!frm.doc.company){frappe.throw(__("Please select Company"));}}
if(!frm.pos){var wrapper=frm.page.add_view("pos","<div>");frm.pos=new erpnext.pos.PointOfSale(wrapper,frm);}
frm.page.set_view(frm.page.current_view_name==="pos"?"main":"pos");frm.toolbar.current_status=null;frm.refresh();if(frm.page.current_view_name==="pos"){frm.pos.refresh();}};